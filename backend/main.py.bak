from fastapi import FastAPI, Depends, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from sqlalchemy.orm import Session
from typing import List
from datetime import datetime

from database import get_db, init_db, Lead as LeadModel
from schemas import LeadCreate, LeadResponse
from enrichment import enrichment_service

app = FastAPI(title="AEGIS API - Block 3 (Enrichment)", version="3.0.0")

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000","http://localhost:3001","http://localhost:3002","http://localhost:3003"],
    allow_credentials=True, allow_methods=["*"], allow_headers=["*"],
)

@app.on_event("startup")
def startup_event():
    print("ðŸš€ Starting AEGIS API...")
    init_db()
    print("âœ… Database ready!")

@app.get("/")
def root():
    return {"message": "ðŸŽ‰ AEGIS API running", "version": "Block 3", "timestamp": datetime.now().isoformat()}

@app.post("/api/leads/capture", response_model=LeadResponse)
async def capture_lead(lead_data: LeadCreate, db: Session = Depends(get_db)):
    existing = db.query(LeadModel).filter(LeadModel.email == lead_data.email).first()
    if existing:
        raise HTTPException(status_code=400, detail=f"Lead with email {lead_data.email} already exists!")

    enriched = await enrichment_service.enrich_lead(lead_data.name, lead_data.email, lead_data.phone)

    lead = LeadModel(
        name=lead_data.name,
        email=lead_data.email,
        phone=lead_data.phone,
        status="new",
        company=enriched.get("company"),
        job_title=enriched.get("job_title"),
        location=enriched.get("location"),
        linkedin_url=enriched.get("linkedin_url"),
        company_size=enriched.get("company_size"),
        industry=enriched.get("industry"),
        enriched=enriched.get("enriched", "success"),
        enriched_at=enriched.get("enriched_at"),
    )
    db.add(lead); db.commit(); db.refresh(lead)
    return lead

@app.get("/api/leads", response_model=List[LeadResponse])
def list_leads(db: Session = Depends(get_db)):
    return db.query(LeadModel).order_by(LeadModel.created_at.desc()).all()

@app.get("/api/leads/{lead_id}", response_model=LeadResponse)
def get_lead(lead_id: int, db: Session = Depends(get_db)):
    lead = db.query(LeadModel).filter(LeadModel.id == lead_id).first()
    if not lead:
        raise HTTPException(status_code=404, detail="Lead not found")
    return lead

@app.get("/api/leads/stats/count")
def leads_count(db: Session = Depends(get_db)):
    c = db.query(LeadModel).count()
    return {"total_leads": c, "message": f"You have {c} leads in the database!"}

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8010)
